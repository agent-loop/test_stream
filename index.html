<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Screen Sharing</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        video { width: 80%; max-width: 800px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        input { padding: 5px; margin: 5px; }
        #log { margin-top: 20px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>
    <h1>Internet Screen Sharing</h1>
    <div id="role-selection">
        <button onclick="selectRole('streamer')">Be a Streamer</button>
        <button onclick="selectRole('viewer')">Be a Viewer</button>
    </div>

    <div id="streamer-controls" style="display: none;">
        <h2>Streamer</h2>
        <video id="streamer-preview" autoplay playsinline muted></video>
        <div>
            <button onclick="startStreaming()">Start Streaming</button>
            <p>Share this link with viewers: <span id="room-link"></span></p>
        </div>
    </div>

    <div id="viewer-controls" style="display: none;">
        <h2>Viewer</h2>
        <input id="room-id-input" placeholder="Enter Room ID from Streamer">
        <button onclick="joinAsViewer()">Join Stream</button>
        <video id="viewer-video" autoplay playsinline></video>
    </div>

    <div id="log"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDPxnvaYapJ4BO2h7PoKw435amJ6i-qYOc",
            authDomain: "screenshareapp-2a85f.firebaseapp.com",
            projectId: "screenshareapp-2a85f",
            storageBucket: "screenshareapp-2a85f.firebasestorage.app",
            messagingSenderId: "252523208229",
            appId: "1:252523208229:web:15b6e19a8c597b6edd69cc",
            measurementId: "G-1Y9EBEKM9E"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let role, localStream, roomId;
        const peerConnections = new Map();
        const configuration = {
            iceServers: [
                { urls: "stun:openrelay.metered.ca:80" },
                { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" }
            ]
        };

        function log(message) {
            document.getElementById('log').innerHTML += `<p>${new Date().toLocaleTimeString()} - ${message}</p>`;
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 10);
        }

        function selectRole(selectedRole) {
            role = selectedRole;
            document.getElementById('role-selection').style.display = 'none';
            if (role === 'streamer') {
                document.getElementById('streamer-controls').style.display = 'block';
                roomId = generateRoomId();
                document.getElementById('room-link').textContent = `${window.location.href}?room=${roomId}`;
                log(`Your Room ID: ${roomId}`);
            } else {
                document.getElementById('viewer-controls').style.display = 'block';
            }
        }

        async function startStreaming() {
            try {
                log("Starting screen share...");
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                document.getElementById('streamer-preview').srcObject = localStream;
                log("Screen sharing started.");

                const pc = await createPeerConnection(null, true);
                peerConnections.set('streamer', pc);
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                db.ref(`rooms/${roomId}/offer`).set({
                    sdp: offer.sdp,
                    type: offer.type
                });
                log("Offer sent to viewers. Share the link above!");

                db.ref(`rooms/${roomId}/answers`).on('child_added', async (snapshot) => {
                    const answer = snapshot.val();
                    const viewerId = snapshot.key;
                    const pc = peerConnections.get(viewerId) || await createPeerConnection(viewerId, true);
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                    peerConnections.set(viewerId, pc);
                    log(`Connected to viewer ${viewerId}`);
                });
            } catch (error) {
                log(`Error: ${error}`);
            }
        }

        async function joinAsViewer() {
            roomId = document.getElementById('room-id-input').value.trim();
            if (!roomId) {
                log("Please enter a Room ID.");
                return;
            }

            const offerSnapshot = await db.ref(`rooms/${roomId}/offer`).once('value');
            const offer = offerSnapshot.val();
            if (!offer) {
                log("No stream found for this Room ID. Check with the streamer.");
                return;
            }

            const viewerId = Math.random().toString(36).substring(2, 15);
            const pc = await createPeerConnection(roomId, false);
            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            db.ref(`rooms/${roomId}/answers/${viewerId}`).set({
                sdp: answer.sdp,
                type: answer.type
            });
            peerConnections.set(roomId, pc);
            log("Connected to streamer.");
        }

        async function createPeerConnection(targetId, isStreamer) {
            const pc = new RTCPeerConnection(configuration);

            if (isStreamer && localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            } else {
                pc.ontrack = (event) => {
                    log("Stream received!");
                    document.getElementById('viewer-video').srcObject = event.streams[0];
                };
            }

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    db.ref(`rooms/${roomId}/candidates/${isStreamer ? 'streamer' : 'viewer'}/${Date.now()}`).set(event.candidate);
                }
            };

            db.ref(`rooms/${roomId}/candidates/${isStreamer ? 'viewer' : 'streamer'}`).on('child_added', async (snapshot) => {
                const candidate = snapshot.val();
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            });

            pc.onconnectionstatechange = () => {
                log(`Connection state: ${pc.connectionState}`);
            };

            return pc;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const roomParam = urlParams.get('room');
        if (roomParam) {
            document.getElementById('room-id-input').value = roomParam;
            selectRole('viewer');
        }
    </script>
</body>
</html>
